<app-header></app-header>

<div class="container mt-4" *ngIf="!loading">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      
      <!-- Profile Card -->
      <div class="profile-card">
        <div class="profile-content">
          <!-- Profile Picture -->
          <div class="profile-avatar">
            <img *ngIf="user.profileImageUrl" [src]="user.profileImageUrl" [alt]="user.displayName" class="profile-img">
            <i *ngIf="!user.profileImageUrl" class="bi bi-person-circle profile-icon"></i>
          </div>
          
          <!-- Profile Info -->
          <div class="profile-info">
            <h1 class="profile-name">{{ user.displayName }}</h1>
            <p class="member-since">Member since {{ formatMemberSince(user.memberSince) }}</p>
            
            <!-- Edit Button -->
            <button class="btn-edit-profile" (click)="startEditingProfile()" *ngIf="!editingProfile">
              <i class="bi bi-pencil"></i> Edit Profile
            </button>
          </div>
        </div>
      </div>

      <!-- Edit Profile Form -->
      <div class="edit-profile-section" *ngIf="editingProfile">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Edit Profile Information</h5>
          </div>
          <div class="card-body">
            <form (ngSubmit)="saveProfile()">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Display Name</label>
                  <input type="text" class="form-control" [(ngModel)]="profileForm.displayName" name="displayName" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" [(ngModel)]="profileForm.email" name="email" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Phone</label>
                  <input type="tel" class="form-control" [(ngModel)]="profileForm.phone" name="phone">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Location</label>
                  <input type="text" class="form-control" [(ngModel)]="profileForm.location" name="location">
                </div>
                <div class="col-12 mb-3">
                  <label class="form-label">Bio</label>
                  <textarea class="form-control" rows="3" [(ngModel)]="profileForm.bio" name="bio" placeholder="Tell us about yourself..."></textarea>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-check"></i> Save Changes
                </button>
                <button type="button" class="btn btn-secondary" (click)="cancelEditingProfile()">
                  <i class="bi bi-x"></i> Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Offers Section -->
      <div class="offers-section" *ngIf="!loadingOffers && offers.length > 0">
        <div class="offers-header">
          <h3 class="offers-title">Offers ({{ offers.length }})</h3>
        </div>
        
        <div class="offers-grid">
          <div class="offer-card" *ngFor="let offer of offers">
            <div class="offer-image-container">
              <!-- Show actual image if it exists -->
              <img *ngIf="offer.image" 
                   [src]="offer.image" 
                   [alt]="offer.title" 
                   class="offer-image" 
                   (error)="onImageError(offer, $event)"
                   (load)="onImageLoad(offer, $event)">
              
              <!-- Show type-specific icon only when no image exists -->
              <div *ngIf="!offer.image" class="offer-image-placeholder">
                <i [class]="getOfferTypeIcon(offer.type)" class="placeholder-icon"></i>
                <span class="placeholder-text">No Image</span>
              </div>
              
              <!-- Type badge always visible in top-right corner -->
              <div class="offer-type-badge">
                <i [class]="getOfferTypeIcon(offer.type)"></i>
              </div>
            </div>
            <div class="offer-content">
              <h4 class="offer-title">{{ offer.title }}</h4>
              <p class="offer-location">{{ offer.location }}</p>
              <p class="offer-price">{{ offer.price }}</p>
            </div>
            <div class="offer-actions">
              <button class="btn-action btn-view" (click)="viewOffer(offer)" title="View Offer">
                <i class="bi bi-eye"></i>
              </button>
              <button class="btn-action btn-edit" (click)="editOffer(offer)" title="Edit Offer">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn-action btn-delete" (click)="deleteOffer(offer)" title="Delete Offer">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State for Offers -->
      <div class="offers-section" *ngIf="loadingOffers">
        <div class="text-center">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading offers...</span>
          </div>
          <p class="mt-2">Loading your offers...</p>
        </div>
      </div>

      <!-- Empty State for Offers -->
      <div class="offers-section" *ngIf="!loadingOffers && offers.length === 0">
        <div class="text-center">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h4 class="mt-3 text-muted">No Offers Yet</h4>
          <p class="text-muted">You haven't created any offers yet. Start by creating your first offer!</p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Loading State -->
<div class="container mt-4" *ngIf="loading">
  <div class="text-center">
    <div class="spinner-border text-success" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading profile...</p>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1" *ngIf="showEditModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil me-2"></i>
          Edit {{ editingOffer?.type === 'equipment' ? 'Equipment' : 'Farmer' }} Offer
        </h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <!-- Equipment Offer Fields -->
          <div *ngIf="editingOffer?.type === 'equipment'">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" [(ngModel)]="editForm.title" name="title" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Price (JOD) *</label>
                <input type="number" class="form-control" [(ngModel)]="editForm.price" name="price" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Location *</label>
                <input type="text" class="form-control" [(ngModel)]="editForm.location" name="location" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Condition *</label>
                <select class="form-select" [(ngModel)]="editForm.condition" name="condition" required>
                  <option value="New">New</option>
                  <option value="Used">Used</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Delivery Type *</label>
                <select class="form-select" [(ngModel)]="editForm.deliveryType" name="deliveryType" required>
                  <option value="SelfPickup">Self Pickup Only</option>
                  <option value="DeliveryPaid">Delivery Available (Paid)</option>
                  <option value="FreeDelivery">Free Delivery</option>
                  <option value="DeliveryOnly">Delivery Only</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Contact Number</label>
                <input type="tel" class="form-control" [(ngModel)]="editForm.contactNumber" name="contactNumber">
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" rows="3" [(ngModel)]="editForm.description" name="description"></textarea>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Images</label>
                <div class="image-upload-section">
                  <div class="current-images" *ngIf="editingOffer?.originalOffer?.photos?.length > 0">
                    <div class="image-item" *ngFor="let photo of editingOffer.originalOffer.photos; let i = index">
                      <img [src]="constructImageUrl(photo.url)" [alt]="'Image ' + (i + 1)" class="preview-image">
                      <button type="button" class="btn btn-sm btn-danger remove-image-btn" (click)="removeImage(photo.id)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="upload-area" (click)="triggerImageUpload()">
                    <i class="bi bi-cloud-upload"></i>
                    <p>Click to add more images</p>
                    <input type="file" #imageInput (change)="onImageSelected($event)" multiple accept="image/*" style="display: none;">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Farmer Offer Fields -->
          <div *ngIf="editingOffer?.type === 'farmer'">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name *</label>
                <input type="text" class="form-control" [(ngModel)]="editForm.fullName" name="fullName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Age</label>
                <input type="number" class="form-control" [(ngModel)]="editForm.age" name="age">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Current Address *</label>
                <input type="text" class="form-control" [(ngModel)]="editForm.currentAddress" name="currentAddress" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Employment Type *</label>
                <select class="form-select" [(ngModel)]="editForm.employmentType" name="employmentType" required>
                  <option value="0">Part-Time</option>
                  <option value="1">Full-Time</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Contact Number</label>
                <input type="tel" class="form-control" [(ngModel)]="editForm.contactNumber" name="contactNumber">
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" rows="3" [(ngModel)]="editForm.description" name="description"></textarea>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Images</label>
                <div class="image-upload-section">
                  <div class="current-images" *ngIf="editingOffer?.originalOffer?.photos?.length > 0">
                    <div class="image-item" *ngFor="let photo of editingOffer.originalOffer.photos; let i = index">
                      <img [src]="constructImageUrl(photo.url)" [alt]="'Image ' + (i + 1)" class="preview-image">
                      <button type="button" class="btn btn-sm btn-danger remove-image-btn" (click)="removeImage(photo.id)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="upload-area" (click)="triggerImageUpload()">
                    <i class="bi bi-cloud-upload"></i>
                    <p>Click to add more images</p>
                    <input type="file" #imageInput (change)="onImageSelected($event)" multiple accept="image/*" style="display: none;">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Land Offer Fields -->
          <div *ngIf="editingOffer?.type === 'land'">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" [(ngModel)]="editForm.title" name="title" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Price (JOD) *</label>
                <input type="number" class="form-control" [(ngModel)]="editForm.price" name="price" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Location *</label>
                <input type="text" class="form-control" [(ngModel)]="editForm.location" name="location" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Contact Number</label>
                <input type="tel" class="form-control" [(ngModel)]="editForm.contactNumber" name="contactNumber">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Land Size (acres)</label>
                <input type="number" class="form-control" [(ngModel)]="editForm.landSize" name="landSize" step="0.1">
              </div>
              <div class="col-md-6 mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="editForm.isForRent" name="isForRent" id="isForRent">
                  <label class="form-check-label" for="isForRent">
                    Available for Rent
                  </label>
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="editForm.isForRent">
                <label class="form-label">Lease Duration (months)</label>
                <input type="number" class="form-control" [(ngModel)]="editForm.leaseDuration" name="leaseDuration">
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" rows="3" [(ngModel)]="editForm.description" name="description"></textarea>
              </div>
              <div class="col-12 mb-3">
                <label class="form-label">Images</label>
                <div class="image-upload-section">
                  <div class="current-images" *ngIf="editingOffer?.originalOffer?.photos?.length > 0">
                    <div class="image-item" *ngFor="let photo of editingOffer.originalOffer.photos; let i = index">
                      <img [src]="constructImageUrl(photo.url)" [alt]="'Image ' + (i + 1)" class="preview-image">
                      <button type="button" class="btn btn-sm btn-danger remove-image-btn" (click)="removeImage(photo.id)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="upload-area" (click)="triggerImageUpload()">
                    <i class="bi bi-cloud-upload"></i>
                    <p>Click to add more images</p>
                    <input type="file" #imageInput (change)="onImageSelected($event)" multiple accept="image/*" style="display: none;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
          <i class="bi bi-x-circle me-1"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" (click)="saveEdit()">
          <i class="bi bi-check-circle me-1"></i> Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showEditModal" *ngIf="showEditModal"></div>

<!-- Confirmation Modal -->
<div class="modal fade" [class.show]="showConfirmModal" [style.display]="showConfirmModal ? 'block' : 'none'" tabindex="-1" *ngIf="showConfirmModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
          Confirm Action
        </h5>
        <button type="button" class="btn-close" (click)="closeConfirmModal()"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">{{ confirmMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfirmModal()">
          <i class="bi bi-x-circle me-1"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmAction()">
          <i class="bi bi-check-circle me-1"></i> Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showConfirmModal" *ngIf="showConfirmModal"></div>


<app-footer></app-footer>
